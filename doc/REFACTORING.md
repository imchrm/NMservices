# Рефакторинг структуры проекта

## Что было улучшено

### 1. Конфигурация (src/nms/config.py)
- Создан централизованный модуль конфигурации с использованием `pydantic-settings`
- Все настройки теперь в одном месте
- Поддержка `.env` файлов
- Кеширование настроек через `@lru_cache`

### 2. Модели данных (src/nms/models/)
Модели разделены по доменам:
- `models/user.py` - модели пользователей
- `models/order.py` - модели заказов
- Улучшена документация моделей с помощью Field descriptions

### 3. Сервисный слой (src/nms/services/)
Бизнес-логика вынесена из эндпоинтов в сервисы:
- `services/auth.py` - AuthService для аутентификации и регистрации
- `services/order.py` - OrderService для работы с заказами
- Каждый сервис - класс с понятными методами

### 4. API слой (src/nms/api/)
Эндпоинты организованы в роутеры:
- `api/dependencies.py` - общие зависимости (проверка API ключа)
- `api/users.py` - роутер для работы с пользователями (префикс `/users`)
- `api/orders.py` - роутер для работы с заказами (префикс `/orders`)

### 5. Главный модуль (src/nms/main.py)
- Упрощен и очищен от бизнес-логики
- Подключены роутеры
- Сохранена обратная совместимость со старыми эндпоинтами `/register` и `/create_order` (помечены как deprecated)

### 6. Тесты (tests/)
- Обновлены для использования конфигурации
- Все тесты проходят успешно

### 7. Добавлены файлы
- `.env.example` - шаблон переменных окружения

## Новая структура проекта

```
src/nms/
├── api/
│   ├── __init__.py
│   ├── dependencies.py    # Общие зависимости
│   ├── users.py          # Роутер пользователей
│   └── orders.py         # Роутер заказов
├── models/
│   ├── __init__.py
│   ├── user.py           # Модели пользователей
│   └── order.py          # Модели заказов
├── services/
│   ├── __init__.py
│   ├── auth.py           # Сервис аутентификации
│   ├── order.py          # Сервис заказов
│   └── user_agree.py     # (резерв)
├── config.py             # Конфигурация приложения
└── main.py               # Точка входа
```

## Новые эндпоинты

### Основные (рекомендуются)
- `POST /users/register` - регистрация пользователя
- `POST /orders` - создание заказа

### Legacy (устаревшие, но работают)
- `POST /register` - старый эндпоинт регистрации (deprecated)
- `POST /create_order` - старый эндпоинт создания заказа (deprecated)

## Запуск

```bash
# Установка зависимостей
poetry install

# Запуск сервера
poetry run nms

# Или
poetry run uvicorn nms.main:app --reload --app-dir src

# Запуск тестов
poetry run pytest
```

## Преимущества новой структуры

1. **Separation of Concerns** - каждый модуль отвечает за свою задачу
2. **Масштабируемость** - легко добавлять новые домены
3. **Тестируемость** - сервисы можно тестировать независимо
4. **Поддерживаемость** - код легче читать и понимать
5. **Обратная совместимость** - старые эндпоинты продолжают работать
6. **Clean Architecture** - слои чётко разделены

## Следующие шаги

1. Постепенно мигрировать клиентов на новые эндпоинты
2. Реализовать реальную базу данных вместо моков
3. Добавить middleware для логирования
4. Добавить обработку ошибок
5. Реализовать user_agree сервис
