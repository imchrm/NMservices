# Глобальный план работ: Этап MVP

## Обзор

**Цель MVP:** Реализовать минимальный функционал для приёма заказов на услуги массажа через Telegram-бот с управлением через Admin Panel.

**Компоненты системы:**
| Компонент | Технологии | Путь |
|-----------|------------|------|
| Backend (микросервисы) | Python, FastAPI, uvicorn | `C:\Users\zum\dev\python\NMservices` |
| Frontend (Telegram-бот) | Python, aiogram | `C:\Users\zum\dev\python\NMservices` |
| Frontend (Admin Panel) | TypeScript, React, react-admin, Vite | `C:\Users\zum\dev\js\NMservices-Admin` |
| База данных | PostgreSQL | nomus |

**Текущий статус:** MVP-0 завершён (базовые таблицы users, orders; API endpoints)

---

## План работ

### Задача 1: Backend — Каталог услуг и расширение заказов

**Описание:** Реализация функционала согласно `docs/tasks/MVP_services_table.md`

**Подзадачи:**
- [ ] 1.1. Миграция: создание таблицы `services`
- [ ] 1.2. Миграция: расширение таблицы `orders` (service_id, address_text, scheduled_at)
- [ ] 1.3. SQLAlchemy модели (Service, обновление Order)
- [ ] 1.4. Pydantic модели (ServiceResponse, ServiceCreateRequest, обновление OrderCreateRequest)
- [ ] 1.5. API endpoints для услуг (CRUD)
- [ ] 1.6. Обновление API endpoints для заказов
- [ ] 1.7. Seed данные (базовые услуги)
- [ ] 1.8. Обновление CLI утилиты (управление услугами)
- [ ] 1.9. Тесты для новых endpoints
- [ ] 1.10. Обновление документации

**Критерии завершения:** см. `docs/tasks/MVP_services_table.md` → Критерии приёмки

---

### Задача 2: Telegram-бот — Флоу создания заказа

**Описание:** Реализация пользовательского сценария заказа услуги

**Подзадачи:**
- [ ] 2.1. Интеграция с API услуг (получение списка активных услуг)
- [ ] 2.2. Экран выбора услуги (inline-кнопки или меню)
- [ ] 2.3. Ввод адреса (текстовое сообщение)
- [ ] 2.4. Подтверждение заказа (summary + кнопки Подтвердить/Отмена)
- [ ] 2.5. Отправка заказа в API
- [ ] 2.6. Сообщение об успешном создании заказа
- [ ] 2.7. Обработка ошибок (услуга не найдена, API недоступен)

**User flow:**
```
/start или кнопка "Заказать"
    → Список услуг (название + цена + длительность)
    → Выбор услуги
    → "Введите адрес"
    → Ввод адреса
    → "Ваш заказ: [услуга], [адрес], [цена]. Подтвердить?"
    → [Подтвердить] / [Отмена]
    → "Заказ #123 создан! Мы свяжемся с вами."
```

**Критерии завершения:**
- Пользователь может выбрать услугу из каталога
- Пользователь может указать адрес
- Заказ сохраняется в БД через API
- Пользователь получает подтверждение

---

### Задача 3: Telegram-бот — Уведомления о статусе заказа

**Описание:** Пользователь получает сообщение при изменении статуса заказа

**Подзадачи:**
- [ ] 3.1. Webhook/polling endpoint для получения событий об изменении статуса
- [ ] 3.2. Сервис отправки уведомлений по telegram_id
- [ ] 3.3. Шаблоны сообщений для разных статусов
- [ ] 3.4. Обработка случая, когда пользователь заблокировал бота

**Статусы заказа (примерные):**
- `pending` → "Заказ принят"
- `confirmed` → "Заказ подтверждён, мастер выезжает"
- `in_progress` → "Мастер на месте"
- `completed` → "Заказ выполнен. Спасибо!"
- `cancelled` → "Заказ отменён"

**Критерии завершения:**
- При смене статуса заказа пользователь получает сообщение в Telegram

---

### Задача 4: Admin Panel — Управление услугами

**Описание:** CRUD для таблицы services в Admin Panel

**Подзадачи:**
- [ ] 4.1. Подключение к API `/services`
- [ ] 4.2. Список услуг (таблица с фильтрацией и сортировкой)
- [ ] 4.3. Просмотр услуги (детальная карточка)
- [ ] 4.4. Создание услуги (форма)
- [ ] 4.5. Редактирование услуги
- [ ] 4.6. Деактивация услуги (soft delete)

**Критерии завершения:**
- Администратор может просматривать список услуг
- Администратор может создавать/редактировать/деактивировать услуги

---

### Задача 5: Admin Panel — Управление заказами

**Описание:** CRUD для таблицы orders в Admin Panel

**Подзадачи:**
- [ ] 5.1. Подключение к API `/orders`
- [ ] 5.2. Список заказов (таблица с фильтрацией по статусу, дате)
- [ ] 5.3. Просмотр заказа (детали: пользователь, услуга, адрес, статус)
- [ ] 5.4. Редактирование заказа (смена статуса, notes)
- [ ] 5.5. Создание заказа (ручное создание администратором)
- [ ] 5.6. Удаление/отмена заказа

**Критерии завершения:**
- Администратор может просматривать все заказы
- Администратор может менять статус заказа
- При смене статуса срабатывает уведомление пользователю (связь с Задачей 3)

---

### Задача 6: Admin Panel — Просмотр пользователей

**Описание:** Read-only доступ к списку пользователей

**Подзадачи:**
- [ ] 6.1. Подключение к API `/users`
- [ ] 6.2. Список пользователей (таблица)
- [ ] 6.3. Просмотр пользователя (профиль + история заказов)

**Критерии завершения:**
- Администратор может просматривать список пользователей
- Администратор видит историю заказов пользователя

---

### Задача 7: Интеграция и тестирование

**Описание:** Проверка работы всей системы целиком

**Подзадачи:**
- [ ] 7.1. E2E тест: создание заказа через бот → отображение в Admin Panel
- [ ] 7.2. E2E тест: смена статуса в Admin Panel → уведомление в Telegram
- [ ] 7.3. Проверка работы при ошибках (API down, невалидные данные)
- [ ] 7.4. Документирование API (OpenAPI/Swagger актуален)

**Критерии завершения:**
- Полный цикл заказа работает
- Система устойчива к ошибкам

---

## Зависимости между задачами

```
Задача 1 (Backend)
    ├── Задача 2 (Бот: флоу заказа) — требует API услуг и заказов
    ├── Задача 4 (Admin: услуги) — требует API услуг
    └── Задача 5 (Admin: заказы) — требует API заказов
            └── Задача 3 (Бот: уведомления) — требует механизм смены статуса

Задача 6 (Admin: пользователи) — независима, требует только API users

Задача 7 (Интеграция) — после всех остальных задач
```

**Рекомендуемый порядок:**
1. **Задача 1** — Backend (блокирует большинство задач)
2. **Задачи 2, 4, 5, 6** — параллельно после завершения Backend
3. **Задача 3** — после Задачи 5 (нужен механизм смены статуса)
4. **Задача 7** — финальная интеграция

---

## Оценка объёма

| Задача | Компонент | Сложность |
|--------|-----------|-----------|
| 1 | Backend | Средняя |
| 2 | Telegram-бот | Средняя |
| 3 | Telegram-бот | Низкая |
| 4 | Admin Panel | Низкая |
| 5 | Admin Panel | Средняя |
| 6 | Admin Panel | Низкая |
| 7 | Все | Низкая |

---

## Риски

| Риск | Вероятность | Митигация |
|------|-------------|-----------|
| Изменение требований | Средняя | Гибкая архитектура, MVP подход |
| Проблемы с Telegram API | Низкая | Rate limiting, retry логика |
| Несовместимость версий | Низкая | Фиксация версий зависимостей |

---

## Связанные документы

- [MVP Services Table](./MVP_services_table.md) — детальное ТЗ для Задачи 1
- `docs/database-schema-mvp.md` — схема БД (обновить после Задачи 1)

---

## История изменений

| Дата | Версия | Описание |
|------|--------|----------|
| 2025-02-03 | 1.0 | Создание плана |
